#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ПАТЧ для bot.py v4.13
Скопируй эти изменения в свой bot.py
"""

# ══════════════════════════════════════════════════════════════
# ИЗМЕНЕНИЕ 1: VERSION (строка ~20, после импортов)
# ══════════════════════════════════════════════════════════════
# БЫЛО:
# VERSION = "4.10"
# 
# СТАЛО:
VERSION = "4.13"


# ══════════════════════════════════════════════════════════════
# ИЗМЕНЕНИЕ 2: Закомментировать v2traffic (строка ~1069)
# ══════════════════════════════════════════════════════════════
# БЫЛО:
# app.add_handler(CommandHandler("v2traffic", self.v2ray_commands.cmd_v2traffic))
# 
# СТАЛО:
# app.add_handler(CommandHandler("v2traffic", self.v2ray_commands.cmd_v2traffic))  # TODO: v4.14


# ══════════════════════════════════════════════════════════════
# ИЗМЕНЕНИЕ 3: Обновить cmd_help (замени всю функцию)
# ══════════════════════════════════════════════════════════════

async def cmd_help(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Помощь по командам"""
    user_id = update.effective_user.id
    
    if self.is_owner(user_id):
        text = """📚 Команды владельца (v4.13):

🏢 КЛУБЫ:
/clubs - список клубов
/addclub <название> - добавить клуб
/stats [клуб] [дней] - статистика клуба

📊 ОТЧЁТЫ:
/report <клуб> - создать отчёт смены
/shift <shift_id> - просмотр отчёта

💸 РАСХОДЫ (v4.13):
/expenses [клуб] [дней] - статистика расходов
/expenses_history [клуб] [дней] - история расходов
/add_expense <shift_id> <сумма> <описание> - добавить расход

🔐 V2RAY (v4.13):
/v2ray - главное меню V2Ray
/v2add <имя> <host> <user> <pass> [sni] - добавить сервер
/v2setup <имя> - установить Xray (2-3 мин)
/v2user <сервер> <user_id> [email] - добавить пользователь
/v2sni <сервер> <сайт> - изменить маскировку
/v2stats <имя> - статистика сервера
/v2list - список серверов
/v2remove <сервер> <uuid> - удалить пользователя

👥 АДМИНИСТРАТОРЫ:
/addadmin <user_id> <club_id> - добавить админа
/removeadmin <user_id> - удалить админа
/listadmins - список админов

📚 БАЗА ЗНАНИЙ:
/knowledge - меню базы знаний
/search <запрос> - поиск в базе
/add_document - добавить документ
/stats_kb - статистика базы

ℹ️ СИСТЕМА:
/help - эта справка
/version - версия бота"""
        
    elif self.is_admin(user_id):
        text = """📚 Команды администратора (v4.13):

📊 ОТЧЁТЫ:
/report <клуб> - создать отчёт смены

📝 Форматы расходов в отчёте:
- "- 4500 вика зп"
- "зп вика 4500"
- "закупка 1500 monster"
- "инкассация 10000"

📚 БАЗА ЗНАНИЙ:
/knowledge - меню базы знаний
/search <запрос> - поиск

ℹ️ ПОМОЩЬ:
/help - эта справка"""
        
    else:
        text = """📚 Команды пользователя (v4.13):

📚 БАЗА ЗНАНИЙ:
/knowledge - меню базы знаний
/search <запрос> - поиск информации

ℹ️ Для доступа к функциям управления обратитесь к администратору.
/help - эта справка"""
    
    await update.message.reply_text(text)


# ══════════════════════════════════════════════════════════════
# ИЗМЕНЕНИЕ 4: Добавить cmd_version (новая функция)
# ══════════════════════════════════════════════════════════════

async def cmd_version(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Показать версию бота"""
    text = f"""🤖 Club Assistant Bot
    
📦 Версия: v{VERSION}
📅 Дата: 2025-10-16

✨ Что нового в v4.13:
• Улучшенный парсинг расходов (5+ форматов)
• Автоопределение получателя и категории
• 6 категорий расходов с группировкой
• Полный V2Ray Manager с REALITY
• SSH управление серверами
• Генерация ключей и VLESS ссылок

📊 Статистика:
• База знаний: {len(self.vector_store.vectors)} векторов
• Записей: {len(self.knowledge_base.entries)} шт

🔗 GitHub: https://github.com/nik45114/Bot_Claude"""
    
    await update.message.reply_text(text)


# ══════════════════════════════════════════════════════════════
# ИЗМЕНЕНИЕ 5: Регистрация команды /version (в методе run())
# ══════════════════════════════════════════════════════════════
# Добавь рядом с другими CommandHandler:

app.add_handler(CommandHandler("version", self.cmd_version))


# ══════════════════════════════════════════════════════════════
# ИЗМЕНЕНИЕ 6: Стартовое сообщение (в функции main())
# ══════════════════════════════════════════════════════════════
# БЫЛО:
# print("=" * 60)
# print("   Club Assistant Bot v4.10")
# print("   Database Fix Edition")
# print("=" * 60)
#
# СТАЛО:
print("=" * 60)
print(f"   Club Assistant Bot v{VERSION}")
print("   Enhanced Reports + V2Ray REALITY Edition")
print("=" * 60)


# ══════════════════════════════════════════════════════════════
# ИЗМЕНЕНИЕ 7: Логи (в функции main())
# ══════════════════════════════════════════════════════════════
# БЫЛО:
# logger.info("🚀 Инициализация v4.8...")
# logger.info("✅ Бот v4.10 готов!")
#
# СТАЛО:
logger.info(f"🚀 Инициализация v{VERSION}...")
logger.info(f"✅ Бот v{VERSION} готов!")


# ══════════════════════════════════════════════════════════════
# ГОТОВО!
# ══════════════════════════════════════════════════════════════
# После применения патча:
# 1. Версия будет v4.13
# 2. /help покажет все новые команды
# 3. /version покажет информацию о боте
# 4. Ошибка v2traffic исправлена
