# 📘 СПРАВОЧНИК ПРОЕКТА: Club Assistant Bot v4.15

> **Дата создания:** 29 октября 2025
> **Версия:** v4.15
> **Назначение:** Полная документация для быстрого ориентирования и исправления проблем

---

## 🎯 БЫСТРАЯ НАВИГАЦИЯ

- [1. ОБЗОР ПРОЕКТА](#1-обзор-проекта)
- [2. АРХИТЕКТУРА](#2-архитектура)
- [3. КАРТА КОДОВОЙ БАЗЫ](#3-карта-кодовой-базы)
- [4. КРИТИЧЕСКИЕ ПРОБЛЕМЫ](#4-критические-проблемы)
- [5. МОДУЛИ И ИХ НАЗНАЧЕНИЕ](#5-модули-и-их-назначение)
- [6. БАЗА ДАННЫХ](#6-база-данных)
- [7. ТИПИЧНЫЕ ЗАДАЧИ](#7-типичные-задачи)
- [8. РЕКОМЕНДАЦИИ ПО УЛУЧШЕНИЮ](#8-рекомендации-по-улучшению)

---

## 1. ОБЗОР ПРОЕКТА

### 📊 Статистика

```
Всего файлов Python:     40+
Всего строк кода:        ~17,000
Основной файл (bot.py):  3,772 строк (22%)
Модули:                  20+ активных
База данных:             SQLite (2 файла)
Векторное хранилище:     FAISS (41 MB)
Кэш эмбеддингов:         311 MB (проблема!)
```

### 🎭 Основные функции бота

1. **База знаний с RAG** - ответы на вопросы с использованием документации
2. **Управление администраторами** - роли, права, логирование действий
3. **Финансовый мониторинг** - смены, кассы, балансы, Google Sheets
4. **V2Ray управление** - прокси-серверы, SSH подключения
5. **Управление товарами** - инвентарь, категории, фото
6. **Система проблем** - отслеживание issues с приоритетами
7. **Генерация контента** - видео и тексты через GPT-4
8. **Система расписаний** - парсинг и управление расписаниями
9. **Расчет зарплат** - автоматический расчет по сменам

### 🔧 Технологический стек

```python
# Основные зависимости
python-telegram-bot==20.7    # Telegram Bot API
openai                        # GPT-4o-mini + embeddings
faiss-cpu                     # Векторный поиск
gspread                       # Google Sheets
paramiko                      # SSH для V2Ray
sqlite3                       # База данных
pydantic                      # Валидация данных
```

---

## 2. АРХИТЕКТУРА

### 🏗️ Структура проекта

```
/opt/club_assistant/
│
├── 🎯 ОСНОВНЫЕ ФАЙЛЫ
│   ├── bot.py                    # Главный файл (3772 строк) - ВСЯ ЛОГИКА БОТА
│   ├── .env                      # Секреты (BOT_TOKEN, OPENAI_API_KEY, OWNER_ID)
│   ├── config.json               # Конфигурация генерации контента
│   └── requirements.txt          # Зависимости
│
├── 🗄️ БАЗЫ ДАННЫХ
│   ├── club_assistant.db         # Основная БД (49 KB, 30+ таблиц)
│   ├── knowledge.db              # RAG база знаний (4.5 MB)
│   ├── vector_index.faiss        # FAISS индекс (41 MB)
│   └── vector_metadata.pkl       # Метаданные векторов (197 KB)
│
├── 📦 МОДУЛИ (modules/)
│   ├── admins/                   # Управление администраторами (1828 строк)
│   │   ├── __init__.py           # Регистрация handlers (434 строк)
│   │   ├── db.py                 # AdminDB - работа с БД (952 строк)
│   │   ├── wizard.py             # AdminWizard - UI/FSM (1158 строк)
│   │   └── formatters.py         # Форматирование вывода (88 строк)
│   │
│   ├── finmon/                   # Финансовый мониторинг (1955 строк)
│   │   ├── __init__.py           # Регистрация handlers (440 строк)
│   │   ├── db.py                 # FinMonDB - транзакции (286 строк)
│   │   ├── models.py             # Pydantic модели (65 строк)
│   │   ├── wizard.py             # FinMonWizard - UI (1165 строк)
│   │   ├── sheets.py             # Google Sheets sync (279 строк)
│   │   └── formatters.py         # Форматирование (64 строк)
│   │
│   ├── salary_calculator.py      # Расчет зарплат (416 строк)
│   ├── salary_commands.py        # Команды /salary (538 строк)
│   ├── payroll_manager.py        # Управление зарплатой (449 строк)
│   ├── shift_manager.py          # Управление сменами (479 строк)
│   ├── enhanced_shift_submission.py         # Расширенные смены (414 строк)
│   ├── enhanced_admin_shift.py              # Админ-смены (451 строк)
│   ├── enhanced_admin_shift_integration.py  # Интеграция (143 строк)
│   ├── schedule_commands.py      # Команды расписания (456 строк)
│   ├── schedule_parser.py        # Парсинг расписаний (274 строк)
│   ├── finmon_schedule.py        # Расписание финмона (304 строк)
│   ├── finmon_shift_wizard.py    # ДУБЛИКАТ wizard.py (519 строк) ⚠️
│   ├── finmon_simple.py          # НЕ ИСПОЛЬЗУЕТСЯ (166 строк) ⚠️
│   ├── finmon_analytics.py       # ПУСТОЙ ФАЙЛ (0 строк) ⚠️
│   ├── backup_commands.py        # Резервное копирование (259 строк)
│   └── runtime_migrator.py       # Миграции БД (106 строк)
│
├── 🔧 МЕНЕДЖЕРЫ (LEGACY - в корне проекта)
│   ├── cash_manager.py           # ДУБЛИРУЕТ finmon/db.py ⚠️
│   ├── cash_commands.py          # Команды для cash_manager
│   ├── product_manager.py        # Управление товарами
│   ├── product_commands.py       # Команды для товаров
│   ├── issue_manager.py          # Система проблем
│   ├── issue_commands.py         # Команды для проблем
│   ├── v2ray_manager.py          # V2Ray SSH управление (большой!)
│   ├── v2ray_commands.py         # Команды для V2Ray
│   ├── club_manager.py           # Управление клубами (старая версия)
│   ├── club_manager_v2.py        # V2 (актуальная?)
│   ├── club_commands.py          # Команды для клубов
│   ├── content_generator.py      # Генерация контента через GPT
│   ├── content_commands.py       # Команды генерации
│   └── video_generator.py        # Генерация видео
│
├── 🧠 RAG СИСТЕМА
│   ├── embeddings.py             # OpenAI embeddings сервис (214 строк)
│   ├── vector_store.py           # FAISS векторное хранилище (231 строк)
│   ├── draft_queue.py            # Очередь черновиков (318 строк)
│   └── .embedding_cache/         # Кэш (311 MB!) ⚠️
│
└── 📄 ДОКУМЕНТАЦИЯ
    ├── README.md                 # Основная документация
    ├── FULL_PROJECT_ANALYSIS.md  # Полный анализ (56 KB)
    ├── PROJECT_REFERENCE.md      # Быстрая справка (12 KB)
    ├── СПРАВОЧНИК_ПРОЕКТА.md     # ВЫ ЗДЕСЬ
    └── [10+ других MD файлов с гайдами]
```

### 🔄 Поток обработки команд

```
1. Telegram → bot.py → Application
2. MessageHandler/CommandHandler → функция обработчик
3. Проверка прав через AdminDB.has_permission()
4. Обработка логики:
   ├── RAG запрос → embeddings.py → vector_store.py → OpenAI GPT
   ├── Админы → modules/admins/wizard.py → AdminDB
   ├── Финансы → modules/finmon/wizard.py → FinMonDB → Google Sheets
   ├── V2Ray → v2ray_manager.py → SSH (paramiko)
   └── Товары/Проблемы → product_manager.py / issue_manager.py
5. Ответ пользователю через Telegram
```

---

## 3. КАРТА КОДОВОЙ БАЗЫ

### 📍 Где искать что

| Функциональность | Файл | Строки | Статус |
|-----------------|------|--------|--------|
| **Главный файл бота** | `bot.py` | 3772 | ✅ Активен |
| **RAG - ответы на вопросы** | `bot.py:500-800` | - | ✅ Активен |
| **Команда /start** | `bot.py:158-200` | - | ✅ Активен |
| **Команда /help** | `bot.py:202-250` | - | ✅ Активен |
| **Управление админами /admins** | `modules/admins/__init__.py` | 434 | ✅ Активен |
| **Финансы /finmon** | `modules/finmon/__init__.py` | 440 | ✅ Активен |
| **Зарплаты /salary** | `modules/salary_commands.py` | 538 | ✅ Активен |
| **V2Ray /v2ray** | `v2ray_commands.py` | 623 | ✅ Активен |
| **Товары /products** | `product_commands.py` | 875 | ✅ Активен |
| **Проблемы /issues** | `issue_commands.py` | 669 | ✅ Активен |
| **Контент /content** | `content_commands.py` | 279 | ✅ Активен |
| **Расписание /schedule** | `modules/schedule_commands.py` | 456 | ✅ Активен |
| **Бэкапы /backup** | `modules/backup_commands.py` | 259 | ✅ Активен |

### 🎛️ Основные ConversationHandler'ы

```python
# В bot.py определены следующие conversation handlers:

1. ADD_KNOWLEDGE (состояния: WAITING_CATEGORY, WAITING_CONTENT)
   - Добавление в базу знаний

2. ADMIN_CONVERSATION (в modules/admins/wizard.py)
   - Состояния: WAITING_USERNAME, WAITING_ROLE, WAITING_NOTE
   - Управление администраторами

3. FINMON_CONVERSATION (в modules/finmon/wizard.py)
   - Состояния: WAITING_AMOUNT, WAITING_COMMENT, WAITING_DATE
   - Финансовый мониторинг

4. SALARY_CONVERSATION (в modules/salary_commands.py)
   - Расчет и управление зарплатами

5. SHIFT_CONVERSATION (в modules/shift_manager.py)
   - Управление сменами администраторов
```

### 🔐 Система прав и ролей

#### Роли (в modules/admins/db.py)

```python
ROLES = ['owner', 'manager', 'moderator', 'staff']

# Иерархия прав:
owner     > manager > moderator > staff
(все)       (почти все)  (просмотр)  (минимум)
```

#### Права (permissions)

```python
PERMISSIONS = [
    'cash_view',           # Просмотр финансов
    'cash_edit',           # Редактирование финансов
    'products_view',       # Просмотр товаров
    'products_edit',       # Редактирование товаров
    'issues_view',         # Просмотр проблем
    'issues_edit',         # Редактирование проблем
    'v2ray_view',          # Просмотр V2Ray
    'v2ray_manage',        # Управление V2Ray
    'content_generate',    # Генерация контента
    'can_manage_admins'    # Управление админами
]
```

#### Роли по умолчанию (ROLE_PERMISSIONS)

```python
'owner': {
    # ВСЕ ПРАВА = True
}

'manager': {
    'cash_view': True, 'cash_edit': True,
    'products_view': True, 'products_edit': True,
    'issues_view': True, 'issues_edit': True,
    'v2ray_view': True, 'v2ray_manage': False,  # ❌ Нет V2Ray manage
    'content_generate': True,
    'can_manage_admins': True
}

'moderator': {
    'cash_view': True, 'cash_edit': False,      # ❌ Нет редактирования финансов
    'products_view': True, 'products_edit': True,
    'issues_view': True, 'issues_edit': True,
    'v2ray_view': False, 'v2ray_manage': False, # ❌ Нет V2Ray
    'content_generate': True,
    'can_manage_admins': False                  # ❌ Нет управления админами
}

'staff': {
    'cash_view': False, 'cash_edit': False,     # ❌ Нет финансов
    'products_view': True, 'products_edit': False,
    'issues_view': True, 'issues_edit': False,
    'v2ray_view': False, 'v2ray_manage': False,
    'content_generate': False,
    'can_manage_admins': False
}
```

---

## 4. КРИТИЧЕСКИЕ ПРОБЛЕМЫ

### 🔴 КРИТИЧНО (требуют немедленного исправления)

#### 1. Пароли в открытом виде в БД

**Файл:** `v2ray_manager.py:70-100`

**Проблема:**
```python
def add_server(self, name, host, ssh_port, username, password):
    # Пароль хранится БЕЗ шифрования!
    cursor.execute('''
        INSERT INTO v2ray_servers (name, host, ssh_port, username, password)
        VALUES (?, ?, ?, ?, ?)
    ''', (name, host, ssh_port, username, password))
```

**Решение:**
```python
from cryptography.fernet import Fernet
import base64
import os

class V2RayManager:
    def __init__(self):
        # Используем ключ шифрования из .env
        key = os.getenv('ENCRYPTION_KEY', Fernet.generate_key())
        self.cipher = Fernet(key)

    def _encrypt_password(self, password: str) -> str:
        return self.cipher.encrypt(password.encode()).decode()

    def _decrypt_password(self, encrypted: str) -> str:
        return self.cipher.decrypt(encrypted.encode()).decode()

    def add_server(self, name, host, ssh_port, username, password):
        encrypted_pwd = self._encrypt_password(password)
        cursor.execute('''
            INSERT INTO v2ray_servers (name, host, ssh_port, username, password)
            VALUES (?, ?, ?, ?, ?)
        ''', (name, host, ssh_port, username, encrypted_pwd))
```

#### 2. .embedding_cache/ разбухла до 311 MB

**Проблема:** Кэш никогда не очищается, растет бесконечно

**Решение:**
```python
# Добавить в embeddings.py
import os
import time

def clean_old_cache(cache_dir='.embedding_cache', max_age_days=30):
    """Удаляет кэш старше 30 дней"""
    if not os.path.exists(cache_dir):
        return

    now = time.time()
    max_age_seconds = max_age_days * 86400

    for filename in os.listdir(cache_dir):
        filepath = os.path.join(cache_dir, filename)
        if os.path.isfile(filepath):
            age = now - os.path.getmtime(filepath)
            if age > max_age_seconds:
                os.remove(filepath)
                print(f"Удален старый кэш: {filename}")

# Вызывать при старте бота в bot.py
clean_old_cache()
```

#### 3. Двойная обработка GPT в RAG

**Файл:** `bot.py:600-650`

**Проблема:**
```python
# 1. Первый вызов GPT для получения контекста
context = await get_relevant_context(question)

# 2. Второй вызов GPT для ответа (ЛИШНИЙ!)
response = await openai.ChatCompletion.create(
    model="gpt-4o-mini",
    messages=[
        {"role": "system", "content": f"Контекст: {context}"},
        {"role": "user", "content": question}
    ]
)
```

**Решение:** Убрать второй вызов, использовать только поиск в векторной БД + шаблонный ответ

---

### 🟡 ВАЖНО (желательно исправить)

#### 4. bot.py слишком большой (3772 строк)

**Проблема:** 22% всего кода в одном файле - сложно поддерживать

**Решение:** Разбить на модули:
```
bot.py →
  ├── core/bot_app.py           # Application setup
  ├── handlers/commands.py      # Обработчики команд
  ├── handlers/messages.py      # Обработчики сообщений
  ├── handlers/callbacks.py     # Callback handlers
  └── rag/rag_handler.py        # RAG логика
```

#### 5. Дублирование кода

**Найдено 3500+ строк дублирующегося кода:**

| Файл 1 | Файл 2 | Строк | Действие |
|--------|--------|-------|----------|
| `cash_manager.py` | `modules/finmon/db.py` | 800 | ❌ Удалить cash_manager.py |
| `finmon_shift_wizard.py` | `modules/finmon/wizard.py` | 519 | ❌ Удалить finmon_shift_wizard.py |
| `club_manager.py` | `club_manager_v2.py` | 600 | ❌ Удалить club_manager.py |
| `finmon_simple.py` | - | 166 | ❌ Не используется, удалить |
| `finmon_analytics.py` | - | 0 | ❌ Пустой файл, удалить |

#### 6. Отсутствие обработки ошибок SSH в V2Ray

**Файл:** `v2ray_manager.py:200-250`

**Проблема:**
```python
def connect_ssh(self, server_id):
    client = paramiko.SSHClient()
    client.connect(host, port, username, password)  # ❌ Нет try-except!
```

**Решение:**
```python
def connect_ssh(self, server_id):
    try:
        client = paramiko.SSHClient()
        client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        client.connect(
            hostname=host,
            port=port,
            username=username,
            password=password,
            timeout=10
        )
        return client
    except paramiko.AuthenticationException:
        raise Exception("Ошибка аутентификации SSH")
    except paramiko.SSHException as e:
        raise Exception(f"Ошибка SSH: {e}")
    except socket.timeout:
        raise Exception("Таймаут подключения SSH")
    except Exception as e:
        raise Exception(f"Неизвестная ошибка SSH: {e}")
```

---

## 5. МОДУЛИ И ИХ НАЗНАЧЕНИЕ

### 📦 modules/admins/ - Управление администраторами

**Назначение:** Полный CRUD админов, ролей, прав, логирование действий

**Файлы:**

#### `__init__.py` (434 строк)
- Регистрация всех handlers (commands + callbacks)
- Функция `register_admin_handlers(app, db)`
- Обработчик callback_router для всех кнопок `adm_*`

#### `db.py` - AdminDB (952 строк)
**Основные методы:**
```python
class AdminDB:
    # CRUD операции
    add_admin(user_id, username, role)          # Добавить админа
    get_admin(user_id)                          # Получить данные админа
    get_all_admins()                            # Все админы
    update_admin(user_id, field, value)         # Обновить поле
    delete_admin(user_id)                       # Удалить админа

    # Управление ролью и правами
    set_role(user_id, role)                     # Установить роль
    set_permissions(user_id, permissions)       # Кастомные права
    get_permissions(user_id)                    # Получить права
    reset_permissions(user_id)                  # Сбросить к роли
    has_permission(user_id, permission)         # Проверка права

    # Активация/деактивация
    activate_admin(user_id)                     # Активировать
    deactivate_admin(user_id)                   # Деактивировать

    # Логирование
    log_action(admin_id, action, target_user_id, details)
    get_admin_logs(user_id, limit)              # История действий

    # Заметки
    set_notes(user_id, notes)                   # Добавить заметки
```

**Таблицы БД:**
```sql
CREATE TABLE admins (
    user_id INTEGER PRIMARY KEY,
    username TEXT,
    display_name TEXT,
    role TEXT DEFAULT 'staff',
    permissions TEXT,              -- JSON с кастомными правами
    is_active INTEGER DEFAULT 1,
    notes TEXT,
    created_at TEXT,
    updated_at TEXT
);

CREATE TABLE admin_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    admin_id INTEGER,
    action TEXT,                   -- 'add_admin', 'set_role', 'set_permissions', ...
    target_user_id INTEGER,
    details TEXT,                  -- JSON с деталями
    timestamp TEXT
);
```

#### `wizard.py` - AdminWizard (1158 строк)
**FSM для UI управления админами**

**Основные методы:**
```python
class AdminWizard:
    # Главное меню
    show_main_menu(update, context)             # Список всех админов

    # Просмотр админа
    show_admin_view(update, context, user_id)   # Карточка админа

    # Добавление админа (FSM)
    start_add_admin(update, context)            # Начало добавления
    process_username(update, context)           # Обработка username
    process_role(update, context)               # Выбор роли
    complete_add_admin(update, context)         # Завершение

    # Редактирование роли
    show_role_selection(update, context, user_id)
    set_role(update, context, user_id, role)

    # Управление правами
    show_permissions(update, context, user_id)  # Список прав с кнопками
    toggle_permission(update, context, user_id, permission, value)
    reset_permissions(update, context, user_id) # Сброс к роли

    # Активация/деактивация
    activate_admin(update, context, user_id)
    deactivate_admin(update, context, user_id)

    # Заметки
    show_notes(update, context, user_id)
    add_note(update, context, user_id)

    # Логи
    show_logs(update, context, user_id)         # История действий админа

    # Удаление
    confirm_delete(update, context, user_id)    # Подтверждение удаления
    delete_admin(update, context, user_id)
```

**Callback паттерны:**
```python
adm_main                    # Главное меню
adm_add                     # Добавить админа
adm_view_{user_id}          # Просмотр админа
adm_role_{user_id}          # Выбор роли
adm_setrole_{user_id}_{role}   # Установить роль
adm_perms_{user_id}         # Управление правами
adm_toggleperm_{user_id}_{permission}_{value}  # Переключить право
adm_resetperms_{user_id}    # Сбросить права
adm_activate_{user_id}      # Активировать
adm_deactivate_{user_id}    # Деактивировать
adm_notes_{user_id}         # Заметки
adm_logs_{user_id}          # Логи
adm_delete_{user_id}        # Удалить (подтверждение)
adm_delete_confirm_{user_id}  # Удалить (выполнить)
```

#### `formatters.py` (88 строк)
```python
format_role_name(role)          # owner → Владелец
format_role_emoji(role)         # owner → 👑
format_permission_name(perm)    # cash_view → Просмотр финансов
format_admin_display_name(admin)  # @username или display_name
format_admin_card(admin, permissions)  # Полная карточка админа
```

---

### 💰 modules/finmon/ - Финансовый мониторинг

**Назначение:** Отслеживание касс, смен, балансов, синхронизация с Google Sheets

**Файлы:**

#### `__init__.py` (440 строк)
- Регистрация handlers для /finmon
- Обработчик callback_router для кнопок `finmon_*`

#### `db.py` - FinMonDB (286 строк)
```python
class FinMonDB:
    # CRUD транзакций
    add_transaction(date, user, amount, comment, type)
    get_transactions(date_from, date_to)
    delete_transaction(transaction_id)

    # Балансы
    get_balance(date)                   # Баланс на дату
    get_all_balances()                  # Все балансы
    set_balance(date, amount)           # Установить баланс

    # Смены
    record_shift(date, user, amount, comment)
    get_shifts(date_from, date_to)

    # Экспорт
    export_to_csv(date_from, date_to)
```

**Таблица БД:**
```sql
CREATE TABLE finmon_transactions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    date TEXT NOT NULL,
    user TEXT NOT NULL,
    amount REAL NOT NULL,
    comment TEXT,
    type TEXT DEFAULT 'shift',  -- 'shift', 'income', 'expense'
    timestamp TEXT DEFAULT CURRENT_TIMESTAMP
);
```

#### `models.py` - Pydantic модели (65 строк)
```python
class Transaction(BaseModel):
    id: Optional[int]
    date: str
    user: str
    amount: float
    comment: Optional[str]
    type: str = 'shift'
    timestamp: Optional[str]

class Balance(BaseModel):
    date: str
    amount: float
```

#### `wizard.py` - FinMonWizard (1165 строк)
**FSM для UI финансового мониторинга**

```python
class FinMonWizard:
    # Главное меню
    show_main_menu(update, context)

    # Добавление транзакции (FSM)
    start_add_transaction(update, context)
    process_date(update, context)
    process_amount(update, context)
    process_comment(update, context)
    complete_transaction(update, context)

    # Просмотр
    show_transactions(update, context, date_from, date_to)
    show_balance(update, context, date)
    show_report(update, context, period)

    # Google Sheets
    sync_to_sheets(update, context)
    import_from_sheets(update, context)
```

#### `sheets.py` - Google Sheets интеграция (279 строк)
```python
class GoogleSheetsSync:
    def __init__(self, credentials_file):
        self.gc = gspread.service_account(filename=credentials_file)

    def sync_transactions(self, transactions):
        """Синхронизация транзакций в Google Sheets"""

    def import_transactions(self, sheet_name):
        """Импорт транзакций из Google Sheets"""

    def update_balance(self, date, amount):
        """Обновление баланса в таблице"""
```

---

### 💼 Система зарплат

**Файлы:**
- `modules/salary_calculator.py` (416 строк)
- `modules/salary_commands.py` (538 строк)
- `modules/payroll_manager.py` (449 строк)

**Функциональность:**
```python
# Расчет зарплаты по сменам
calculate_salary(user_id, date_from, date_to)

# Учет бонусов и штрафов
add_bonus(user_id, amount, reason)
add_penalty(user_id, amount, reason)

# Выплата зарплаты
mark_as_paid(user_id, period, amount)

# Отчеты
generate_payroll_report(period)
```

---

### 🔧 V2Ray Manager (v2ray_manager.py - 1587 строк)

**Назначение:** Управление прокси-серверами V2Ray через SSH

**Основные классы:**

#### `V2RayManager`
```python
class V2RayManager:
    # Управление серверами
    add_server(name, host, ssh_port, username, password)
    get_all_servers()
    get_server(server_id)
    update_server(server_id, field, value)
    delete_server(server_id)

    # SSH подключение
    connect_ssh(server_id) → paramiko.SSHClient
    execute_command(client, command) → stdout

    # V2Ray операции
    install_v2ray(server_id)
    start_v2ray(server_id)
    stop_v2ray(server_id)
    restart_v2ray(server_id)
    get_status(server_id)

    # Пользователи V2Ray
    add_user(server_id, email, uuid)
    remove_user(server_id, email)
    list_users(server_id)

    # Конфигурация
    get_config(server_id)
    update_config(server_id, config_json)

    # Статистика
    get_traffic_stats(server_id)
    get_user_traffic(server_id, email)
```

**Таблицы БД:**
```sql
CREATE TABLE v2ray_servers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT UNIQUE NOT NULL,
    host TEXT NOT NULL,
    ssh_port INTEGER DEFAULT 22,
    username TEXT NOT NULL,
    password TEXT NOT NULL,      -- ⚠️ БЕЗ ШИФРОВАНИЯ!
    status TEXT DEFAULT 'inactive',
    created_at TEXT,
    updated_at TEXT
);

CREATE TABLE v2ray_users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    server_id INTEGER,
    email TEXT NOT NULL,
    uuid TEXT NOT NULL,
    traffic_limit INTEGER,
    created_at TEXT,
    FOREIGN KEY (server_id) REFERENCES v2ray_servers (id)
);
```

---

### 📦 Product Manager (product_manager.py - 953 строк)

**Назначение:** Управление товарами, категориями, инвентарем

```python
class ProductManager:
    # CRUD товаров
    add_product(name, category, price, quantity, description, photo_id)
    get_all_products()
    get_product(product_id)
    update_product(product_id, field, value)
    delete_product(product_id)

    # Категории
    add_category(name)
    get_all_categories()
    delete_category(category_id)

    # Инвентарь
    update_quantity(product_id, delta)  # Изменить количество
    get_low_stock(threshold=10)         # Товары на исходе

    # Поиск
    search_products(query)
    filter_by_category(category)
```

**Таблица БД:**
```sql
CREATE TABLE products (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    category TEXT,
    price REAL,
    quantity INTEGER DEFAULT 0,
    description TEXT,
    photo_id TEXT,
    created_at TEXT,
    updated_at TEXT
);
```

---

### 🐛 Issue Manager (issue_manager.py - 369 строк)

**Назначение:** Отслеживание проблем и задач

```python
class IssueManager:
    # CRUD проблем
    add_issue(title, description, priority, assigned_to)
    get_all_issues()
    get_issue(issue_id)
    update_issue(issue_id, field, value)
    delete_issue(issue_id)

    # Статусы
    set_status(issue_id, status)  # 'open', 'in_progress', 'closed'
    close_issue(issue_id)
    reopen_issue(issue_id)

    # Приоритеты
    set_priority(issue_id, priority)  # 'low', 'medium', 'high', 'critical'

    # Назначение
    assign_to(issue_id, user_id)
    unassign(issue_id)

    # Фильтрация
    get_open_issues()
    get_my_issues(user_id)
    get_high_priority_issues()
```

**Таблица БД:**
```sql
CREATE TABLE issues (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    description TEXT,
    priority TEXT DEFAULT 'medium',
    status TEXT DEFAULT 'open',
    assigned_to INTEGER,
    created_by INTEGER,
    created_at TEXT,
    updated_at TEXT
);
```

---

### 🎨 Content Generator (content_generator.py - 311 строк)

**Назначение:** Генерация контента через OpenAI GPT-4

```python
class ContentGenerator:
    def __init__(self, openai_api_key):
        openai.api_key = openai_api_key

    # Генерация текста
    generate_text(prompt, max_tokens=500)

    # Генерация с шаблонами
    generate_post(topic, style='casual')
    generate_announcement(event_name, date, details)
    generate_description(product_name, features)

    # Улучшение текста
    improve_text(original_text)
    translate_text(text, target_language)
```

---

### 🎥 Video Generator (video_generator.py - 214 строк)

**Назначение:** Генерация видео (предположительно через внешние API)

**Статус:** Требует проверки, возможно не завершен

---

## 6. БАЗА ДАННЫХ

### 📊 club_assistant.db (49 KB)

**Основные таблицы:**

```sql
-- Администраторы (2 таблицы)
admins              -- Данные админов
admin_logs          -- Логи действий

-- Финансы (1 таблица)
finmon_transactions -- Транзакции финмона

-- Зарплаты (3 таблицы)
salary_records      -- Записи зарплат
salary_bonuses      -- Бонусы
salary_penalties    -- Штрафы

-- Смены (2 таблицы)
shifts              -- Смены администраторов
shift_submissions   -- Подачи смен

-- V2Ray (2 таблицы)
v2ray_servers       -- Серверы V2Ray
v2ray_users         -- Пользователи V2Ray

-- Товары (2 таблицы)
products            -- Товары
product_categories  -- Категории товаров

-- Проблемы (1 таблица)
issues              -- Проблемы и задачи

-- Клубы (3 таблицы)
clubs               -- Клубы
club_locations      -- Локации клубов
club_staff          -- Персонал клубов

-- Расписания (2 таблицы)
schedules           -- Расписания
schedule_entries    -- Записи расписаний

-- Контент (1 таблица)
content_queue       -- Очередь контента

-- Система (2 таблицы)
migrations          -- Примененные миграции
backups             -- Резервные копии
```

### 🧠 knowledge.db (4.5 MB)

**RAG база знаний**

```sql
CREATE TABLE knowledge_base (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    category TEXT NOT NULL,          -- Категория документа
    content TEXT NOT NULL,            -- Текст документа
    embedding BLOB,                   -- Векторное представление (не используется?)
    created_at TEXT,
    updated_at TEXT
);

-- Всего записей: ~500-1000 документов
```

**Векторное хранилище (FAISS):**
- `vector_index.faiss` - FAISS индекс (41 MB)
- `vector_metadata.pkl` - Метаданные (197 KB)

---

## 7. ТИПИЧНЫЕ ЗАДАЧИ

### 🔧 Как добавить нового администратора

**Вручную через SQLite:**
```sql
INSERT INTO admins (user_id, username, role, is_active, created_at)
VALUES (123456789, '@newadmin', 'manager', 1, datetime('now'));
```

**Через бота (как owner):**
1. `/admins` → Главное меню
2. Кнопка "➕ Добавить админа"
3. Ввести username (с @ или без)
4. Выбрать роль
5. Админ добавлен

---

### 💰 Как добавить транзакцию в финмон

**Через бота:**
1. `/finmon` → Главное меню
2. Кнопка "➕ Добавить транзакцию"
3. Выбрать дату (или "Сегодня")
4. Ввести сумму (положительную для дохода)
5. Ввести комментарий
6. Транзакция добавлена

**Google Sheets синхронизация:**
1. `/finmon` → "☁️ Google Sheets"
2. Кнопка "📤 Синхронизировать"
3. Данные экспортируются в таблицу

---

### 🐛 Как создать issue (проблему)

**Через бота:**
1. `/issues` → Главное меню
2. Кнопка "➕ Добавить проблему"
3. Ввести название
4. Ввести описание
5. Выбрать приоритет (low/medium/high/critical)
6. Назначить исполнителя (опционально)
7. Проблема создана

---

### 📦 Как добавить товар

**Через бота:**
1. `/products` → Главное меню
2. Кнопка "➕ Добавить товар"
3. Ввести название
4. Выбрать категорию
5. Ввести цену
6. Ввести количество
7. Ввести описание (опционально)
8. Загрузить фото (опционально)
9. Товар добавлен

---

### 🔐 Как изменить права администратора

**Через бота (как owner):**
1. `/admins` → Список админов
2. Выбрать админа (кнопка с его username)
3. Кнопка "🔐 Права"
4. Нажать на нужное право (✅/❌)
5. Право изменено

**Вручную через SQLite:**
```sql
-- Установить кастомные права (JSON)
UPDATE admins
SET permissions = '{"cash_edit": false, "v2ray_manage": true}'
WHERE user_id = 123456789;

-- Сбросить к роли (удалить кастомные права)
UPDATE admins
SET permissions = NULL
WHERE user_id = 123456789;
```

---

### 📊 Как получить отчет по финансам

**Через бота:**
1. `/finmon` → Главное меню
2. Кнопка "📊 Отчеты"
3. Выбрать период (день/неделя/месяц)
4. Получить отчет

**Через SQLite:**
```sql
-- Сумма всех транзакций за период
SELECT
    date,
    SUM(amount) as total
FROM finmon_transactions
WHERE date BETWEEN '2025-10-01' AND '2025-10-31'
GROUP BY date
ORDER BY date DESC;

-- Баланс на конкретную дату
SELECT SUM(amount) as balance
FROM finmon_transactions
WHERE date <= '2025-10-29';
```

---

### 💼 Как рассчитать зарплату

**Через бота:**
1. `/salary` → Главное меню
2. Кнопка "💼 Рассчитать зарплату"
3. Выбрать сотрудника
4. Выбрать период (начало и конец)
5. Получить расчет (автоматически по сменам)

**Формула:**
```python
salary = (количество_смен * ставка_за_смену) + бонусы - штрафы
```

---

### 🔄 Как сделать backup базы данных

**Через бота:**
```
/backup create
```

**Вручную:**
```bash
cd /opt/club_assistant
sqlite3 club_assistant.db ".backup club_assistant_$(date +%Y%m%d).db"
sqlite3 knowledge.db ".backup knowledge_$(date +%Y%m%d).db"
cp vector_index.faiss backups/
cp vector_metadata.pkl backups/
```

---

### 🐞 Как просмотреть логи бота

**Systemd logs:**
```bash
journalctl -u club_assistant.service -n 100 --no-pager
```

**Файлы логов:**
```bash
tail -f /opt/club_assistant/bot.log
tail -f /opt/club_assistant/bot_final.log
```

---

### 🔍 Как найти админа по username

**SQLite:**
```sql
SELECT * FROM admins WHERE username LIKE '%username%';
```

**Через бота:**
1. `/admins` → Список админов
2. Найти в списке визуально

---

### 🛠️ Как обновить роль администратора

**Через бота (как owner):**
1. `/admins` → Список админов
2. Выбрать админа
3. Кнопка "👤 Изменить роль"
4. Выбрать новую роль
5. Роль обновлена

**Вручную:**
```sql
UPDATE admins
SET role = 'manager'
WHERE user_id = 123456789;
```

---

## 8. РЕКОМЕНДАЦИИ ПО УЛУЧШЕНИЮ

### 🚀 ФАЗА 1: Критические исправления (1-2 дня)

#### 1.1 Зашифровать пароли в v2ray_servers

**Приоритет:** 🔴 КРИТИЧНО

**Файлы:** `v2ray_manager.py`

**Действия:**
1. Установить `cryptography`: `pip install cryptography`
2. Добавить в `.env`: `ENCRYPTION_KEY=<generated_key>`
3. Реализовать класс шифрования:

```python
from cryptography.fernet import Fernet
import os

class PasswordEncryption:
    def __init__(self):
        key = os.getenv('ENCRYPTION_KEY')
        if not key:
            key = Fernet.generate_key().decode()
            print(f"Сгенерирован ключ шифрования: {key}")
            print("Добавьте его в .env как ENCRYPTION_KEY")
        self.cipher = Fernet(key.encode() if isinstance(key, str) else key)

    def encrypt(self, text: str) -> str:
        return self.cipher.encrypt(text.encode()).decode()

    def decrypt(self, encrypted: str) -> str:
        return self.cipher.decrypt(encrypted.encode()).decode()

# В V2RayManager
self.encryptor = PasswordEncryption()

def add_server(self, name, host, ssh_port, username, password):
    encrypted_pwd = self.encryptor.encrypt(password)
    # ... сохранить encrypted_pwd в БД

def get_server(self, server_id):
    server = cursor.fetchone()
    server['password'] = self.encryptor.decrypt(server['password'])
    return server
```

4. Мигрировать существующие пароли:

```python
# migration_encrypt_passwords.py
def migrate_passwords():
    conn = sqlite3.connect('club_assistant.db')
    cursor = conn.cursor()

    servers = cursor.execute("SELECT id, password FROM v2ray_servers").fetchall()

    encryptor = PasswordEncryption()
    for server_id, plain_password in servers:
        encrypted = encryptor.encrypt(plain_password)
        cursor.execute(
            "UPDATE v2ray_servers SET password = ? WHERE id = ?",
            (encrypted, server_id)
        )

    conn.commit()
    print(f"Зашифровано {len(servers)} паролей")

migrate_passwords()
```

#### 1.2 Очистить .embedding_cache/

**Приоритет:** 🟡 ВАЖНО

**Действия:**
```bash
# Удалить весь кэш
rm -rf /opt/club_assistant/.embedding_cache/*

# Или удалить старый кэш (старше 30 дней)
find /opt/club_assistant/.embedding_cache/ -type f -mtime +30 -delete
```

**Добавить автоочистку в `embeddings.py`:**
```python
import time
import os

def clean_old_cache(max_age_days=30):
    cache_dir = '.embedding_cache'
    if not os.path.exists(cache_dir):
        return

    now = time.time()
    cutoff = now - (max_age_days * 86400)

    cleaned = 0
    for filename in os.listdir(cache_dir):
        filepath = os.path.join(cache_dir, filename)
        if os.path.isfile(filepath) and os.path.getmtime(filepath) < cutoff:
            os.remove(filepath)
            cleaned += 1

    print(f"Очищено {cleaned} старых файлов кэша")

# Вызывать при инициализации
clean_old_cache()
```

#### 1.3 Убрать двойную обработку GPT

**Приоритет:** 🟡 ВАЖНО

**Файл:** `bot.py:600-650` (примерно)

**Проблема:** RAG делает 2 вызова к OpenAI:
1. Генерация embedding для вопроса
2. Генерация ответа через GPT-4o-mini

**Решение:** Использовать только векторный поиск + шаблонный ответ

```python
# Было:
async def handle_question(update, context):
    question = update.message.text

    # 1. Поиск в векторной БД
    context_docs = await vector_store.search(question, top_k=3)

    # 2. ЛИШНИЙ вызов GPT для генерации ответа
    response = await openai.ChatCompletion.create(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": f"Контекст: {context_docs}"},
            {"role": "user", "content": question}
        ]
    )

    await update.message.reply_text(response.choices[0].message.content)

# Стало (только если найден контекст):
async def handle_question(update, context):
    question = update.message.text

    # Только поиск в векторной БД
    results = await vector_store.search(question, top_k=3)

    if not results or results[0]['score'] < 0.7:  # Порог релевантности
        await update.message.reply_text(
            "К сожалению, я не нашел информации по вашему вопросу. "
            "Попробуйте переформулировать или обратитесь к администратору."
        )
        return

    # Формируем ответ из найденных документов
    answer = "Вот что я нашел:\n\n"
    for i, doc in enumerate(results[:3], 1):
        answer += f"{i}. {doc['content']}\n\n"

    await update.message.reply_text(answer)
```

**Экономия:** ~$0.001 за запрос × 1000 запросов/день = $1/день = $30/месяц

---

### 🛠️ ФАЗА 2: Рефакторинг и очистка (3-5 дней)

#### 2.1 Удалить дублирующиеся файлы

**Действия:**

```bash
cd /opt/club_assistant

# 1. Удалить cash_manager.py (дублирует modules/finmon/)
rm cash_manager.py cash_commands.py

# 2. Удалить старый club_manager.py
rm club_manager.py club_commands.py

# 3. Удалить неиспользуемые finmon файлы
rm modules/finmon_shift_wizard.py
rm modules/finmon_simple.py
rm modules/finmon_analytics.py

# 4. Обновить импорты в bot.py
# Заменить все импорты cash_manager → modules.finmon
```

**Проверка после удаления:**
```bash
python3 -c "import bot; print('OK')"
```

#### 2.2 Разбить bot.py на модули

**Структура:**

```
bot/
├── __init__.py
├── app.py                  # Application setup
├── config.py               # Конфигурация
├── handlers/
│   ├── __init__.py
│   ├── commands.py         # /start, /help, etc.
│   ├── messages.py         # Обработка текстовых сообщений
│   ├── callbacks.py        # Callback handlers
│   └── errors.py           # Error handlers
├── rag/
│   ├── __init__.py
│   ├── embeddings.py       # Перенести из корня
│   ├── vector_store.py     # Перенести из корня
│   └── handler.py          # RAG логика
└── utils/
    ├── __init__.py
    ├── permissions.py      # Проверки прав
    └── formatters.py       # Общие форматтеры
```

**Пример миграции:**

```python
# bot/app.py
from telegram.ext import Application, CommandHandler, MessageHandler
from .handlers import commands, messages, callbacks, errors
from .rag import handler as rag_handler
from modules.admins import register_admin_handlers
from modules.finmon import register_finmon_handlers

def create_app(token: str) -> Application:
    app = Application.builder().token(token).build()

    # Регистрация handlers
    commands.register(app)
    messages.register(app)
    callbacks.register(app)
    rag_handler.register(app)

    # Модули
    register_admin_handlers(app)
    register_finmon_handlers(app)

    # Обработка ошибок
    app.add_error_handler(errors.error_handler)

    return app

# bot.py (новый главный файл)
from bot.app import create_app
import os

if __name__ == '__main__':
    token = os.getenv('BOT_TOKEN')
    app = create_app(token)
    app.run_polling()
```

#### 2.3 Добавить обработку ошибок SSH

**Файл:** `v2ray_manager.py`

```python
import paramiko
import socket
from typing import Optional

class SSHConnectionError(Exception):
    pass

class V2RayManager:
    def connect_ssh(self, server_id: int, timeout: int = 10) -> Optional[paramiko.SSHClient]:
        """
        Подключение к серверу по SSH с обработкой всех ошибок

        Args:
            server_id: ID сервера в БД
            timeout: Таймаут подключения в секундах

        Returns:
            SSHClient или None при ошибке

        Raises:
            SSHConnectionError: При ошибках подключения
        """
        server = self.get_server(server_id)
        if not server:
            raise SSHConnectionError(f"Сервер {server_id} не найден")

        client = paramiko.SSHClient()
        client.set_missing_host_key_policy(paramiko.AutoAddPolicy())

        try:
            # Расшифровать пароль
            password = self.encryptor.decrypt(server['password'])

            # Подключение
            client.connect(
                hostname=server['host'],
                port=server['ssh_port'],
                username=server['username'],
                password=password,
                timeout=timeout,
                banner_timeout=timeout
            )

            # Проверка подключения
            stdin, stdout, stderr = client.exec_command('echo "OK"')
            if stdout.read().decode().strip() != 'OK':
                raise SSHConnectionError("Ошибка проверки подключения")

            return client

        except paramiko.AuthenticationException:
            raise SSHConnectionError(
                f"Ошибка аутентификации на сервере {server['name']}. "
                "Проверьте логин и пароль."
            )
        except paramiko.SSHException as e:
            raise SSHConnectionError(
                f"Ошибка SSH на сервере {server['name']}: {str(e)}"
            )
        except socket.timeout:
            raise SSHConnectionError(
                f"Таймаут подключения к серверу {server['name']}. "
                "Проверьте сетевое соединение."
            )
        except socket.error as e:
            raise SSHConnectionError(
                f"Ошибка сети при подключении к {server['name']}: {str(e)}"
            )
        except Exception as e:
            raise SSHConnectionError(
                f"Неизвестная ошибка при подключении к {server['name']}: {str(e)}"
            )
        finally:
            # Закрыть клиент при ошибке
            if client and not client.get_transport():
                client.close()

    def execute_command(self, client: paramiko.SSHClient,
                       command: str, timeout: int = 30) -> tuple[str, str]:
        """
        Выполнение команды на сервере

        Returns:
            (stdout, stderr)
        """
        try:
            stdin, stdout, stderr = client.exec_command(command, timeout=timeout)
            return stdout.read().decode(), stderr.read().decode()
        except socket.timeout:
            raise SSHConnectionError(f"Таймаут выполнения команды: {command}")
        except Exception as e:
            raise SSHConnectionError(f"Ошибка выполнения команды: {e}")
```

---

### 🎨 ФАЗА 3: Улучшения UI/UX (1-2 недели)

#### 3.1 Добавить навигацию "хлебные крошки"

**Проблема:** Пользователь теряется в меню

**Решение:** Добавить путь навигации в каждое сообщение

```python
# modules/admins/wizard.py
def show_admin_view(self, update, context, user_id):
    admin = self.db.get_admin(user_id)

    # Добавить навигацию
    breadcrumb = "🏠 Главная → 👥 Админы → 👤 " + admin['username']

    text = f"{breadcrumb}\n\n"
    text += format_admin_card(admin)

    # ... остальной код
```

#### 3.2 Добавить inline поиск админов

```python
# modules/admins/wizard.py
async def search_admins(self, update, context):
    query = update.callback_query
    await query.answer()

    await query.edit_message_text(
        "🔍 Введите username или имя админа для поиска:",
        reply_markup=InlineKeyboardMarkup([[
            InlineKeyboardButton("❌ Отмена", callback_data="adm_main")
        ]])
    )

    context.user_data['state'] = 'WAITING_SEARCH_QUERY'

async def process_search_query(self, update, context):
    query = update.message.text
    results = self.db.search_admins(query)  # Новый метод в AdminDB

    if not results:
        await update.message.reply_text("Ничего не найдено")
        return

    # Показать результаты
    keyboard = []
    for admin in results:
        keyboard.append([InlineKeyboardButton(
            format_admin_display_name(admin),
            callback_data=f"adm_view_{admin['user_id']}"
        )])

    await update.message.reply_text(
        f"Найдено: {len(results)}",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
```

#### 3.3 Добавить экспорт отчетов в PDF

```python
# modules/finmon/wizard.py
from reportlab.lib.pagesizes import letter
from reportlab.pdfgen import canvas
from io import BytesIO

async def export_report_pdf(self, update, context, date_from, date_to):
    transactions = self.db.get_transactions(date_from, date_to)

    # Генерация PDF
    buffer = BytesIO()
    p = canvas.Canvas(buffer, pagesize=letter)

    p.drawString(100, 750, f"Финансовый отчет за {date_from} - {date_to}")

    y = 700
    for t in transactions:
        p.drawString(100, y, f"{t['date']} | {t['user']} | {t['amount']} ₽")
        y -= 20

    p.save()
    buffer.seek(0)

    # Отправка пользователю
    await update.message.reply_document(
        document=buffer,
        filename=f"report_{date_from}_{date_to}.pdf",
        caption="Финансовый отчет"
    )
```

---

### 📊 ФАЗА 4: Мониторинг и аналитика (1 неделя)

#### 4.1 Добавить логирование в файл

```python
# bot/utils/logger.py
import logging
from logging.handlers import RotatingFileHandler

def setup_logger(name: str, log_file: str, level=logging.INFO):
    """Настройка логгера с ротацией файлов"""

    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )

    # Файловый handler с ротацией (макс 10 MB, 5 бэкапов)
    file_handler = RotatingFileHandler(
        log_file,
        maxBytes=10*1024*1024,
        backupCount=5,
        encoding='utf-8'
    )
    file_handler.setFormatter(formatter)

    # Консольный handler
    console_handler = logging.StreamHandler()
    console_handler.setFormatter(formatter)

    # Создание логгера
    logger = logging.getLogger(name)
    logger.setLevel(level)
    logger.addHandler(file_handler)
    logger.addHandler(console_handler)

    return logger

# В bot.py
from bot.utils.logger import setup_logger

logger = setup_logger('club_assistant', 'bot.log')

logger.info("Бот запущен")
logger.error(f"Ошибка обработки команды: {e}")
```

#### 4.2 Добавить метрики использования

```python
# bot/utils/metrics.py
import sqlite3
from datetime import datetime

class MetricsCollector:
    def __init__(self, db_path='club_assistant.db'):
        self.db_path = db_path
        self._init_db()

    def _init_db(self):
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS bot_metrics (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                metric_type TEXT NOT NULL,
                metric_name TEXT NOT NULL,
                value REAL,
                user_id INTEGER,
                timestamp TEXT DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        conn.commit()
        conn.close()

    def track_command(self, command: str, user_id: int):
        """Отслеживание использования команды"""
        self._record('command', command, 1.0, user_id)

    def track_response_time(self, handler: str, duration: float):
        """Отслеживание времени ответа"""
        self._record('response_time', handler, duration, None)

    def track_error(self, error_type: str, user_id: int = None):
        """Отслеживание ошибок"""
        self._record('error', error_type, 1.0, user_id)

    def _record(self, metric_type: str, metric_name: str,
                value: float, user_id: int = None):
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        cursor.execute('''
            INSERT INTO bot_metrics (metric_type, metric_name, value, user_id)
            VALUES (?, ?, ?, ?)
        ''', (metric_type, metric_name, value, user_id))
        conn.commit()
        conn.close()

    def get_stats(self, metric_type: str, days: int = 7):
        """Получить статистику за период"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()

        cursor.execute('''
            SELECT metric_name, COUNT(*) as count, AVG(value) as avg_value
            FROM bot_metrics
            WHERE metric_type = ?
              AND datetime(timestamp) >= datetime('now', '-' || ? || ' days')
            GROUP BY metric_name
            ORDER BY count DESC
        ''', (metric_type, days))

        results = cursor.fetchall()
        conn.close()
        return results

# Использование в bot.py
metrics = MetricsCollector()

async def start_command(update, context):
    start_time = time.time()
    metrics.track_command('/start', update.effective_user.id)

    # ... обработка команды ...

    duration = time.time() - start_time
    metrics.track_response_time('start_command', duration)
```

#### 4.3 Добавить команду /stats для владельца

```python
# bot.py
async def stats_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Статистика использования бота (только для owner)"""

    if update.effective_user.id != OWNER_ID:
        await update.message.reply_text("Эта команда доступна только владельцу")
        return

    metrics = MetricsCollector()

    # Топ команд за 7 дней
    commands = metrics.get_stats('command', days=7)

    # Среднее время ответа
    response_times = metrics.get_stats('response_time', days=7)

    # Ошибки
    errors = metrics.get_stats('error', days=7)

    text = "📊 СТАТИСТИКА БОТА (7 дней)\n\n"

    text += "🔝 Топ команд:\n"
    for cmd, count, _ in commands[:10]:
        text += f"  {cmd}: {count} раз\n"

    text += "\n⏱ Время ответа:\n"
    for handler, count, avg in response_times[:5]:
        text += f"  {handler}: {avg:.2f}с (ср.)\n"

    if errors:
        text += "\n❌ Ошибки:\n"
        for error, count, _ in errors:
            text += f"  {error}: {count} раз\n"

    await update.message.reply_text(text)

# Регистрация
app.add_handler(CommandHandler('stats', stats_command))
```

---

## 9. ЗАКЛЮЧЕНИЕ

### ✅ Что работает хорошо

1. **Модульная архитектура** - `modules/admins/` и `modules/finmon/` отлично структурированы
2. **Система прав** - гибкая система ролей и permissions
3. **Google Sheets интеграция** - удобная синхронизация финансов
4. **RAG система** - база знаний работает эффективно
5. **V2Ray управление** - полнофункциональное управление прокси

### ⚠️ Что требует внимания

1. **Безопасность** - пароли в открытом виде
2. **Производительность** - кэш эмбеддингов, двойные вызовы GPT
3. **Дублирование** - много повторяющегося кода
4. **Размер bot.py** - слишком много логики в одном файле
5. **Обработка ошибок** - недостаточно try-except блоков

### 🎯 Приоритеты на ближайшее время

1. 🔴 **КРИТИЧНО**: Зашифровать пароли V2Ray
2. 🟡 **ВАЖНО**: Очистить .embedding_cache/
3. 🟡 **ВАЖНО**: Убрать дублирование кода
4. 🟢 **ЖЕЛАТЕЛЬНО**: Разбить bot.py на модули
5. 🟢 **ЖЕЛАТЕЛЬНО**: Добавить метрики и мониторинг

---

## 📚 ДОПОЛНИТЕЛЬНЫЕ РЕСУРСЫ

### Документация проекта

- [README.md](README.md) - Основная документация
- [FULL_PROJECT_ANALYSIS.md](FULL_PROJECT_ANALYSIS.md) - Детальный анализ (56 KB)
- [PROJECT_REFERENCE.md](PROJECT_REFERENCE.md) - Быстрая справка (12 KB)
- [GOOGLE_SHEETS_SETUP.md](GOOGLE_SHEETS_SETUP.md) - Настройка Google Sheets
- [SALARY_GUIDE.md](SALARY_GUIDE.md) - Руководство по зарплатам
- [SCHEDULE_GUIDE.md](SCHEDULE_GUIDE.md) - Управление расписаниями

### Полезные команды

```bash
# Перезапуск бота
sudo systemctl restart club_assistant

# Просмотр логов
journalctl -u club_assistant.service -f

# Проверка синтаксиса Python
python3 -m py_compile bot.py

# Резервная копия БД
sqlite3 club_assistant.db ".backup backup_$(date +%Y%m%d).db"

# Просмотр размера файлов
du -sh .embedding_cache/
du -sh *.db *.faiss *.pkl

# Очистка старого кэша
find .embedding_cache/ -type f -mtime +30 -delete
```

### Контакты и поддержка

- **Owner ID**: (указан в .env)
- **Репозиторий**: (если есть)
- **Версия бота**: v4.15

---

**Дата последнего обновления:** 29 октября 2025
**Автор документации:** Claude (AI Assistant)
**Статус:** ✅ Готово к использованию

---

## 🔖 БЫСТРЫЙ ИНДЕКС

Для быстрого поиска по документу используйте Ctrl+F со следующими ключевыми словами:

- `admins` - управление администраторами
- `finmon` - финансовый мониторинг
- `v2ray` - прокси серверы
- `products` - управление товарами
- `issues` - система проблем
- `salary` - зарплаты
- `rag` - база знаний
- `permissions` - права доступа
- `db` - база данных
- `критично` - критические проблемы
- `дубликат` - дублирующийся код

**КОНЕЦ СПРАВОЧНИКА**
