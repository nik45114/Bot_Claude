# Система управления администраторами и контроля смен v4.14

## Обзор

Новая система управления администраторами и контроля смен включает:

- **Полная видимость всех админов** добавленных через `addadmin`
- **Система контроля смен** с прикреплением фото
- **OCR для извлечения чисел** из фото смен
- **Функция ручного обновления** через бота
- **Расширенная статистика и отчеты**

## Новые команды

### Управление администраторами
- `/adminmgmt` - главное меню управления админами
- `/systemstatus` - статус всех систем

### Контроль смен
- `/shiftmgmt` - главное меню контроля смен
- Поддержка прикрепления фото к смене
- Автоматическое извлечение чисел с помощью OCR

### Обновления
- `/manualupdate` - ручное обновление через бота (только владелец)
- `/updatelog` - просмотр лога обновлений

## Установка

### 1. Установка зависимостей

```bash
# Системные пакеты
sudo apt update
sudo apt install -y tesseract-ocr tesseract-ocr-rus libtesseract-dev

# Python пакеты
pip3 install opencv-python>=4.8.0 pytesseract>=0.3.10 Pillow>=10.0.0
```

### 2. Создание директорий

```bash
mkdir -p /opt/club_assistant/photos
mkdir -p /opt/club_assistant/backups
chown -R club_assistant:club_assistant /opt/club_assistant/photos
chown -R club_assistant:club_assistant /opt/club_assistant/backups
```

### 3. Миграция базы данных

```bash
python3 migrate_admin_shift.py
```

### 4. Применение патча к боту

```bash
python3 integration_patch.py bot.py
```

### 5. Перезапуск бота

```bash
systemctl restart club_assistant
```

## Использование

### Управление администраторами

1. **Просмотр списка админов:**
   ```
   /adminmgmt → Список админов
   ```

2. **Статистика админов:**
   ```
   /adminmgmt → Статистика
   ```

3. **Синхронизация с существующими админами:**
   ```
   /adminmgmt → Синхронизация
   ```

### Контроль смен

1. **Сдача смены с фото:**
   ```
   /shiftmgmt → Сдать смену → Выбрать клуб → Ввести данные → Прикрепить фото
   ```

2. **Просмотр отчетов:**
   ```
   /shiftmgmt → Отчеты смен
   ```

3. **Статистика смен:**
   ```
   /shiftmgmt → Статистика
   ```

### OCR обработка

Система автоматически:
- Извлекает числа из фото смен
- Сравнивает с введенными данными
- Показывает уровень уверенности
- Сохраняет результаты для проверки

### Ручное обновление

1. **Обновление через бота:**
   ```
   /manualupdate
   ```

2. **Просмотр лога:**
   ```
   /updatelog
   ```

## Структура базы данных

### Новые таблицы

1. **admin_management** - расширенное управление админами
2. **admin_activity** - активность админов
3. **shift_control** - детальный контроль смен
4. **shift_status_history** - история изменений статуса

### Индексы

Созданы индексы для оптимизации запросов по:
- user_id, role, is_active (админы)
- admin_id, shift_date, status (смены)
- timestamp (активность и история)

## Безопасность

- Все команды управления доступны только владельцу и менеджерам
- Фото сохраняются локально в защищенной директории
- OCR данные не передаются в внешние сервисы
- Логирование всех действий админов

## Мониторинг

### Статус системы

Команда `/systemstatus` показывает:
- Количество админов и их активность
- Статистику смен и OCR
- Доступность компонентов системы

### Логи

- Обновления: `/opt/club_assistant/update.log`
- Активность админов: таблица `admin_activity`
- История смен: таблица `shift_status_history`

## Устранение неполадок

### OCR не работает

1. Проверьте установку Tesseract:
   ```bash
   tesseract --version
   ```

2. Проверьте права на директорию фото:
   ```bash
   ls -la /opt/club_assistant/photos
   ```

### Ошибки базы данных

1. Запустите миграцию повторно:
   ```bash
   python3 migrate_admin_shift.py
   ```

2. Проверьте целостность базы:
   ```bash
   sqlite3 knowledge.db "PRAGMA integrity_check;"
   ```

### Проблемы с обновлением

1. Проверьте лог:
   ```
   /updatelog
   ```

2. Проверьте права Git:
   ```bash
   cd /opt/club_assistant
   git status
   ```

## API для разработчиков

### Основные классы

- `AdminManagementSystem` - управление админами
- `ShiftControlSystem` - контроль смен
- `OCRProcessor` - обработка OCR
- `ManualUpdateSystem` - ручное обновление

### Примеры использования

```python
# Инициализация системы
from modules.admin_shift_integration import AdminShiftIntegration

integration = AdminShiftIntegration("/path/to/db")

# Получение статистики
stats = integration.get_system_status()

# Обработка фото с OCR
ocr_result = integration.ocr_processor.process_image("photo.jpg")
```

## Обновления

Система поддерживает автоматическое обновление через:
- GitHub pull
- Установку зависимостей
- Миграцию базы данных
- Перезапуск сервиса

Все обновления логируются и могут быть откачены через бэкапы.
