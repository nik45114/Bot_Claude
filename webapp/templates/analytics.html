<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--tg-theme-text-color, #000000);
        }

        h2 {
            font-size: 18px;
            font-weight: 600;
            margin-top: 24px;
            margin-bottom: 12px;
            color: var(--tg-theme-text-color, #000000);
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            flex-shrink: 0;
            padding: 8px 16px;
            border-radius: 8px;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .tab:active {
            opacity: 0.7;
        }

        .tab.active {
            background: var(--tg-theme-button-color, #3390ec);
            opacity: 1;
        }

        .tab:not(.active) {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
            opacity: 0.6;
        }

        .chart-container {
            position: relative;
            margin-bottom: 24px;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 12px;
            padding: 16px;
            min-height: 300px;
        }

        .stat-card {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .stat-card-title {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
            margin-bottom: 8px;
        }

        .stat-card-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--tg-theme-text-color, #000000);
        }

        .stat-card-subtitle {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
            margin-top: 4px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .error {
            background: #ff3b30;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .admin-list {
            list-style: none;
        }

        .admin-item {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-name {
            font-weight: 600;
            font-size: 16px;
        }

        .admin-stats {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .period-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .period-btn {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border: none;
            font-size: 14px;
            cursor: pointer;
        }

        .period-btn.active {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        canvas {
            max-width: 100%;
            height: auto !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>

        <div class="tabs">
            <button class="tab active" data-tab="overview">–û–±–∑–æ—Ä</button>
            <button class="tab" data-tab="revenue">–í—ã—Ä—É—á–∫–∞</button>
            <button class="tab" data-tab="admins">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</button>
            <button class="tab" data-tab="salaries">–ó–∞—Ä–ø–ª–∞—Ç—ã</button>
            <button class="tab" data-tab="efficiency">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</button>
        </div>

        <div id="content">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
        document.body.style.backgroundColor = tg.backgroundColor || '#ffffff';

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentTab = 'overview';
        let currentPeriod = 'week';
        let charts = {};

        // API endpoints
        const API_BASE = window.location.origin;

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∞–±–æ–≤
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                switchTab(tabName);
            });
        });

        function switchTab(tabName) {
            currentTab = tabName;

            // –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–±
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tabName);
            });

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç —Ç–∞–±–∞
            loadTabContent(tabName);
        }

        async function loadTabContent(tabName) {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                switch(tabName) {
                    case 'overview':
                        await loadOverview();
                        break;
                    case 'revenue':
                        await loadRevenue();
                        break;
                    case 'admins':
                        await loadAdmins();
                        break;
                    case 'salaries':
                        await loadSalaries();
                        break;
                    case 'efficiency':
                        await loadEfficiency();
                        break;
                }
            } catch (error) {
                console.error('Error loading tab:', error);
                content.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}</div>`;
            }
        }

        // ============================================
        // –û–ë–ó–û–†
        // ============================================
        async function loadOverview() {
            const response = await fetch(`${API_BASE}/api/analytics/overview?period=${currentPeriod}&user_id=${tg.initDataUnsafe.user?.id}`);
            const data = await response.json();

            const html = `
                <div class="period-selector">
                    <button class="period-btn ${currentPeriod === 'day' ? 'active' : ''}" onclick="changePeriod('day')">–î–µ–Ω—å</button>
                    <button class="period-btn ${currentPeriod === 'week' ? 'active' : ''}" onclick="changePeriod('week')">–ù–µ–¥–µ–ª—è</button>
                    <button class="period-btn ${currentPeriod === 'month' ? 'active' : ''}" onclick="changePeriod('month')">–ú–µ—Å—è—Ü</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-title">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</div>
                        <div class="stat-card-value">${formatMoney(data.total_revenue)}</div>
                        <div class="stat-card-subtitle">${data.shifts_count} —Å–º–µ–Ω</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-title">–†–∞—Å—Ö–æ–¥—ã</div>
                        <div class="stat-card-value">${formatMoney(data.total_expenses)}</div>
                        <div class="stat-card-subtitle">${data.expenses_count} –æ–ø–µ—Ä–∞—Ü–∏–π</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-title">–ó–∞—Ä–ø–ª–∞—Ç—ã</div>
                        <div class="stat-card-value">${formatMoney(data.total_salaries)}</div>
                        <div class="stat-card-subtitle">${data.admins_count} –∞–¥–º–∏–Ω–æ–≤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-title">–ü—Ä–∏–±—ã–ª—å</div>
                        <div class="stat-card-value">${formatMoney(data.net_profit)}</div>
                        <div class="stat-card-subtitle">${data.profit_margin}%</div>
                    </div>
                </div>

                <h2>–í—ã—Ä—É—á–∫–∞ –ø–æ –∫–ª—É–±–∞–º</h2>
                <div class="chart-container">
                    <canvas id="clubsChart"></canvas>
                </div>

                <h2>–î–∏–Ω–∞–º–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥</h2>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            `;

            document.getElementById('content').innerHTML = html;

            // –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏
            drawClubsChart(data.clubs);
            drawTrendChart(data.trend);
        }

        // ============================================
        // –í–´–†–£–ß–ö–ê
        // ============================================
        async function loadRevenue() {
            const response = await fetch(`${API_BASE}/api/analytics/revenue?period=${currentPeriod}&user_id=${tg.initDataUnsafe.user?.id}`);
            const data = await response.json();

            const html = `
                <div class="period-selector">
                    <button class="period-btn ${currentPeriod === 'day' ? 'active' : ''}" onclick="changePeriod('day')">–î–µ–Ω—å</button>
                    <button class="period-btn ${currentPeriod === 'week' ? 'active' : ''}" onclick="changePeriod('week')">–ù–µ–¥–µ–ª—è</button>
                    <button class="period-btn ${currentPeriod === 'month' ? 'active' : ''}" onclick="changePeriod('month')">–ú–µ—Å—è—Ü</button>
                </div>

                <div class="stat-card">
                    <div class="stat-card-title">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</div>
                    <div class="stat-card-value">${formatMoney(data.total)}</div>
                    <div class="stat-card-subtitle">–ó–∞ ${getPeriodName()}</div>
                </div>

                <h2>–ü–æ —Ç–∏–ø–∞–º –æ–ø–ª–∞—Ç—ã</h2>
                <div class="chart-container">
                    <canvas id="paymentTypesChart"></canvas>
                </div>

                <h2>–ü–æ –∫–ª—É–±–∞–º</h2>
                <div class="chart-container">
                    <canvas id="revenueByClubChart"></canvas>
                </div>
            `;

            document.getElementById('content').innerHTML = html;

            drawPaymentTypesChart(data.payment_types);
            drawRevenueByClubChart(data.by_club);
        }

        // ============================================
        // –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–´
        // ============================================
        async function loadAdmins() {
            const response = await fetch(`${API_BASE}/api/analytics/admins?period=${currentPeriod}&user_id=${tg.initDataUnsafe.user?.id}`);
            const data = await response.json();

            let html = `
                <div class="period-selector">
                    <button class="period-btn ${currentPeriod === 'day' ? 'active' : ''}" onclick="changePeriod('day')">–î–µ–Ω—å</button>
                    <button class="period-btn ${currentPeriod === 'week' ? 'active' : ''}" onclick="changePeriod('week')">–ù–µ–¥–µ–ª—è</button>
                    <button class="period-btn ${currentPeriod === 'month' ? 'active' : ''}" onclick="changePeriod('month')">–ú–µ—Å—è—Ü</button>
                </div>

                <h2>–†–µ–π—Ç–∏–Ω–≥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</h2>
                <ul class="admin-list">
            `;

            data.admins.forEach((admin, index) => {
                html += `
                    <li class="admin-item">
                        <div>
                            <div class="admin-name">${index + 1}. ${admin.name}</div>
                            <div class="admin-stats">${admin.shifts} —Å–º–µ–Ω ‚Ä¢ ${formatMoney(admin.revenue)} –≤—ã—Ä—É—á–∫–∏</div>
                        </div>
                        <div style="font-size: 20px; font-weight: 700;">${formatMoney(admin.avg_revenue)}</div>
                    </li>
                `;
            });

            html += '</ul>';

            document.getElementById('content').innerHTML = html;
        }

        // ============================================
        // –ó–ê–†–ü–õ–ê–¢–´
        // ============================================
        async function loadSalaries() {
            const response = await fetch(`${API_BASE}/api/analytics/salaries?user_id=${tg.initDataUnsafe.user?.id}`);
            const data = await response.json();

            let html = `
                <div class="stat-card">
                    <div class="stat-card-title">–ò—Ç–æ–≥–æ –∫ –≤—ã–ø–ª–∞—Ç–µ</div>
                    <div class="stat-card-value">${formatMoney(data.total_to_pay)}</div>
                    <div class="stat-card-subtitle">${data.admins_count} –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</div>
                </div>

                <h2>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</h2>
                <ul class="admin-list">
            `;

            data.salaries.forEach(salary => {
                html += `
                    <li class="admin-item">
                        <div>
                            <div class="admin-name">${salary.name}</div>
                            <div class="admin-stats">
                                –ù–∞—á–∏—Å–ª–µ–Ω–æ: ${formatMoney(salary.gross)} ‚Ä¢
                                –í–∑—è—Ç–æ: ${formatMoney(salary.withdrawn)}
                            </div>
                        </div>
                        <div style="font-size: 20px; font-weight: 700; color: ${salary.net > 0 ? '#34c759' : '#ff3b30'};">
                            ${formatMoney(salary.net)}
                        </div>
                    </li>
                `;
            });

            html += '</ul>';

            document.getElementById('content').innerHTML = html;
        }

        // ============================================
        // –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨
        // ============================================
        async function loadEfficiency() {
            const response = await fetch(`${API_BASE}/api/analytics/efficiency?user_id=${tg.initDataUnsafe.user?.id}`);
            const data = await response.json();

            const html = `
                <h2>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</h2>
                <div class="chart-container">
                    <canvas id="weekdayChart"></canvas>
                </div>

                <h2>–õ—É—á—à–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
                <ul class="admin-list">
                    ${data.top_performers.map((admin, idx) => `
                        <li class="admin-item">
                            <div>
                                <div class="admin-name">${idx + 1}. ${admin.name}</div>
                                <div class="admin-stats">–õ—É—á—à–∏–π –¥–µ–Ω—å: ${admin.best_day}</div>
                            </div>
                            <div style="font-size: 16px; font-weight: 600;">
                                ${formatMoney(admin.best_revenue)}
                            </div>
                        </li>
                    `).join('')}
                </ul>
            `;

            document.getElementById('content').innerHTML = html;

            drawWeekdayChart(data.by_weekday);
        }

        // ============================================
        // –ì–†–ê–§–ò–ö–ò
        // ============================================
        function drawClubsChart(data) {
            const ctx = document.getElementById('clubsChart').getContext('2d');

            if (charts.clubsChart) {
                charts.clubsChart.destroy();
            }

            charts.clubsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.club),
                    datasets: [{
                        data: data.map(d => d.revenue),
                        backgroundColor: [
                            'rgba(52, 199, 89, 0.8)',
                            'rgba(0, 122, 255, 0.8)',
                            'rgba(255, 149, 0, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function drawTrendChart(data) {
            const ctx = document.getElementById('trendChart').getContext('2d');

            if (charts.trendChart) {
                charts.trendChart.destroy();
            }

            charts.trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: '–í—ã—Ä—É—á–∫–∞',
                        data: data.map(d => d.revenue),
                        borderColor: 'rgba(52, 199, 89, 1)',
                        backgroundColor: 'rgba(52, 199, 89, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatMoney(value)
                            }
                        }
                    }
                }
            });
        }

        function drawPaymentTypesChart(data) {
            const ctx = document.getElementById('paymentTypesChart').getContext('2d');

            if (charts.paymentTypesChart) {
                charts.paymentTypesChart.destroy();
            }

            charts.paymentTypesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['–ù–∞–ª–∏—á–Ω—ã–µ', '–ë–µ–∑–Ω–∞–ª', 'QR-–∫–æ–¥—ã'],
                    datasets: [{
                        data: [data.cash, data.card, data.qr],
                        backgroundColor: [
                            'rgba(52, 199, 89, 0.8)',
                            'rgba(0, 122, 255, 0.8)',
                            'rgba(255, 149, 0, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatMoney(value)
                            }
                        }
                    }
                }
            });
        }

        function drawRevenueByClubChart(data) {
            const ctx = document.getElementById('revenueByClubChart').getContext('2d');

            if (charts.revenueByClubChart) {
                charts.revenueByClubChart.destroy();
            }

            charts.revenueByClubChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.club),
                    datasets: [{
                        data: data.map(d => d.revenue),
                        backgroundColor: 'rgba(0, 122, 255, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatMoney(value)
                            }
                        }
                    }
                }
            });
        }

        function drawWeekdayChart(data) {
            const ctx = document.getElementById('weekdayChart').getContext('2d');

            if (charts.weekdayChart) {
                charts.weekdayChart.destroy();
            }

            const weekdays = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];

            charts.weekdayChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weekdays,
                    datasets: data.map((admin, idx) => ({
                        label: admin.name,
                        data: admin.values,
                        borderColor: getColor(idx),
                        backgroundColor: 'transparent',
                        tension: 0.4
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatMoney(value)
                            }
                        }
                    }
                }
            });
        }

        // ============================================
        // –£–¢–ò–õ–ò–¢–´
        // ============================================
        function formatMoney(value) {
            if (!value && value !== 0) return '0 ‚ÇΩ';
            return Math.round(value).toLocaleString('ru-RU') + ' ‚ÇΩ';
        }

        function getPeriodName() {
            const names = {
                'day': '–¥–µ–Ω—å',
                'week': '–Ω–µ–¥–µ–ª—é',
                'month': '–º–µ—Å—è—Ü'
            };
            return names[currentPeriod] || '–ø–µ—Ä–∏–æ–¥';
        }

        function changePeriod(period) {
            currentPeriod = period;
            loadTabContent(currentTab);
        }

        function getColor(index) {
            const colors = [
                'rgba(52, 199, 89, 1)',
                'rgba(0, 122, 255, 1)',
                'rgba(255, 149, 0, 1)',
                'rgba(255, 59, 48, 1)',
                'rgba(175, 82, 222, 1)',
                'rgba(255, 204, 0, 1)'
            ];
            return colors[index % colors.length];
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadOverview();
    </script>
</body>
</html>
